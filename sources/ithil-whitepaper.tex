\documentclass[a4paper,10 pt]{article}

\usepackage[utf8]{inputenc}
\usepackage[english]{}
\usepackage{amsmath, amssymb, amsthm}

\newtheorem{theorem}{Theorem}[section]
\newtheorem{corollary}{Corollary}[section]
\newtheorem{problem}{Problem}

\newcommand{\tb}{\verb|TKB|}
\newcommand{\ta}{\verb|TKA|}

\theoremstyle{definition}
\newtheorem{remark}{Remark}
\newtheorem{definition}{Definition}

\begin{document}

\begin{titlepage}
    \begin{center}
        \vspace*{1cm}
            
        \Huge
        \textbf{Ithil}

        \vspace{0.5cm}
        \Large
        {\it A generalised leveraged investment strategies protocol}

        \vspace{1.5cm}
        {\normalsize V1.0.0 - \today}
        \vspace{1.0cm}

        \begin{abstract}
        Ithil aims at introducing undercollateralised leveraged strategies in DeFi - a game changer for traders, liquidity providers and other protocols who can now rely on a variety of investment products to address their needs. Modular and upgradable at its core, Ithil offers users and other protocols leveraged interactions with the DeFi space, enabling an entirely new range of trading opportunities, acting as an open box financial instrument open to everyone.
        \end{abstract}
            
    \end{center}
\end{titlepage}

\section{Introduction}

The DeFi has recently seen an incredible growth and expansion in the user base, seeing the first institutional players come in too. Built on the premises of being an open space where composability and cross-contamination of protocols sits at its core, access to DeFi is getting more difficult as protocols grow in complexity and require extensive research from their users to come up with truly earning strategies. It is commonly seen how LPs on yield aggregators like Beefy Finance need to often move their liquidity to the newest strategies when the previous ones reach a breakdown point where the APY dramatically falls to 0. Similarly, uneducated users who just want a {\it quick and dirty} solution may find themselves losing their capital even when using supposedly "safe" blue-chip protocols like Uniswap.

\subsection{What is Ithil}

At its core, Ithil is build around the concept of uncollateralised leveraged trading.
Leveraged investments are an ancient and famous financial tool which allow traders to invest more than their available liquidity, thanks to a system called leverage. Leveraged investments make it possible for users to take advantage of foreseen profitable market opportunities even if they don't have immediate access to the funds required. On the other hand, it comes with the risk of the trader losing more than in the case of a classical, non-leveraged investment.

Ithil enables leveraged interactions with other DeFi protocols in a composable way, offering to its users a curated set of customisable investment strategies to choose from. Instead of using credit scores or past reputation, Ithil uses a decentralised network of bots to liquidate underperforming positions and prevent impaired loans to become detrimental to the protocol itself.
It can be seen like a decentralised hedge fund yet with a difference: borrowed funds never leave the protocol and traders are ultimately responsible for their own profits or losses.

\subsection{Why is it different}
There are many existing protocols trying to go beyond traditional overcollateralised lending but fail to offer a seamless user experience and remain limited to the realm of a few highly-educated and wealthy DeFi users.

\section{The Vault}
The leveraged investment activities cannot happen without setting a protocol own liquidity, therefore liquidity providers (LPs) are of greatest importance for Ithil. Investors can provide their idle assets and earn profit from the trading fees.
The vault is the core of the protocol; it consists of a non-upgradable contract where LPs lock their tokens to be offered for traders to perform various investment strategies.

Ithil adopts a solid fee management system, in which the fees are withdrawn from the trader in a safe and predictable way, always assuring the trader's solvability.
Our investing system is \textit{value-agnostic}: once a vault relative to the \verb|XYZ| token is created, we do not track its value (in USD or an underlying peg), instead simply assuring the generation of more \verb|XYZ| tokens.

The vault is responsible for the following tasks:
\begin{itemize}
\item Handling staking and unstaking
\item Calculation of the interest rate applied when taking a loan
\item Lending tokens to one of Ithil’s supported strategies
It also contains a list of {\it whitelisted tokens} approved by the governance that can be provided by LPs or borrowed by the traders.
\end{itemize}

LPs are rewarded with \verb|iTokens|, Ithil's interest-bearing tokens representing liquidity put to work in the vault and can be used on other protocols, improving the whole ecosystem composability narrative.

\section{Fee Redistribution}

Ithil generates a steady source of income in the form of fees paid by the traders. Such fees are then redistributed to the LPs proportionately on how much liquidity they provided by accruing value in the vault and increasing the backing of the yield-bearing \verb|iToken|: LPs will only get rewards in the specific token they provided. Provide \verb|DAI| receive \verb|DAI|.
When the tokens are lent to a trader, the vault calculates the fixed fees and the interest rate applied to the loan. The fixed fees are token-specific, community-based percentages of the amount which goes out of the vault, and are the direct compensation to LP for providing their liquidity to Ithil. 

In all cases, fees are considered when deciding whether to liquidate a position, so that the payment is assured for any trader's profit or loss scenario. In particular, a \textit{liquidation factor} $r$ is set for every position, such that the position is liquidated if the trader's payback goes below $r$\% of the margin.

We denote by $L$ the total liquidity of a specific single-token deposit vault, which is the result of both deposits and unclaimed fees generated. To every investor depositing $D_i$ into the pool, we assign a \emph{claiming power} $\lambda_i \le D_i$. The amount of money investor $i$ can claim from the pool will be calculated as $$A_i := \frac{\lambda_i}{\lambda_1+\ldots+\lambda_n}L.$$ We need to calculate the claiming power so that no arbitrage is possible: if an investor deposits $D_i$, and no fee is generated, the investor can claim exactly $D_i$. Therefore
$$ \frac{\lambda_i}{\lambda_1+\ldots+\lambda_i + \ldots +\lambda_n}(L+D_i) = D_i,$$ and solving for $\lambda_i$ we find $$\lambda_i := \frac{\lambda_1 + \ldots + \lambda_{i-1}+\lambda_{i+1}+\ldots+\lambda_n}{L}D_i.$$

\subsection{Scenarios}
By examining deposits and withdrawals scenarios, we find that the no-arbitrage formula also implies that the investors will not see other investor's moves.
\subsubsection{New investor}
Assume there is a new investor providing $D_{n+1}$ to the pool, and assume no fees are generated. Then the old investor $i$ will now claim $$A_i' = \frac{\lambda_i}{\lambda_1+\ldots + \lambda_{n+1}}(L+D_{n+1}),$$ but since $\lambda_{n+1} = \frac{\lambda_1+\ldots+\lambda_n}{L}D_{n+1}$, we have $$A_i' = \frac{\lambda_i(L+D_i)L}{(\lambda_1+\ldots+\lambda_n)(L+D_i)} = A_i$$ so the amount of money which $A_i$ can claim is exactly the one he or she used to have before the new investor's deposit.

\subsubsection{Withdrawal}
Assume an old investor withdraws $W_i \le A_i$ from the pool. Then, we will say that $W_i$ is proportionately distributed between the liquidity and the fees. In particular, the "liquidity" part withdrawn by the investor is $W_i\lambda_i/A_i$, thus the new claiming power of the investor will be $$\lambda_i' = \lambda_i - \frac{W_i\lambda_i}{A_i}=\lambda_i-W_i\frac{\lambda_0+\ldots+\lambda_n}{L}$$ In this way, the claim for another investor $j$ will be $$A_j' = \frac{\lambda_j}{\lambda_1+\ldots+\lambda_n - \frac{W_i\lambda_i}{A_i}}(L-W_i) = \frac{\lambda_j(L-W_i)L}{(\lambda_1+\ldots+\lambda_n)(L-W_i)} = \alpha_jL = A_j. $$ Therefore, funds withdrawal does not affect any other investor's claiming power, just like deposits do.

\section{Interest Rate}

The interest rate is investment-specific and represents the risk beyond the investment as seen from the lender's perspective.
Both the interest rate and the fixed fee applied are returned as a parameter from the dedicate vault’s functions, while the repayment and the logic for the calculation of risk is included in the implementation of the investment strategies. The riskiness is captured in an integer called risk factor which is passed to the vault borrow function as a parameter. The interest rate is then computed as

$$IR = IR_base + RF * L * l_c/l_f$$

Where $IR_base$ is the basic commonly-shared interest rate applied to all tokens decided by the governance, $L$ is the leverage and $l_c/l_f$ is the ration between {\it uncovered liquidity} and {\it free liquidity}: the free liquidity is the {\it available liquidity} in the vault for trading, in that particular token, while the {\it uncovered liquidity} is the amount of free liquidity which is not covered by the vault’s insurance pool.

\section{Risk Factor}
A position is liquidable if the quoted value of its entitlement, plus the margin, minus the quoted value of its debt, all expressed as an amount of margin tokens, is lower than a certain fraction, called the risk factor,
of the position’s margin. Therefore, assuming we are having a long position, calling $P$ the price of a unit of investment token expressed as amount of margin tokens, and $r$ the risk factor for the investment token, then the position can be liquidated if 

$$EN * P + m - d - f < r x m $$

where $EN$ is the entitlement, $m$ the margin posted, $d$ the debt (or loan value taken from the vault) and $f$ the fees accrued excluding the liquidation penalty fees.

The risk factor is token (pair) based: the more volatile the token pair, the higher the risk factor. The main purpose of a high risk factor is to protect the protocol’s liquidity from further adverse market movements occurring before the actual liquidation occurs, or during the closure of the position, since the very action of performing a swap on any dex causes a price impact on the swapped pair.


\section{Strategies}
We can think of strategies as configurable actions executed across several other protocols in a composable way. They span from basic swaps to convoluted lending and farming of liquidity pools' tokens.

In order to be able to open a position in any strategy, a trader has to post a collateral to cover for potential losses caused by unfavorable market movements. The collateral can be posted in any token, and potentially gives the right to use any token type of the ones within the vault. The maximum loan size is determined by imposing that the interest rate, as of Equation (4), should not exceed a maximum interest rate fixed by the governance. For example, in the scenario of a very risky investment (high risk factor), or when most of the vault is uncovered (insurance pool amount too low), the allowed leverage is lower.

{\textbf for the time being we just support Margin Trading, in the future we will add more strategies, both high risk and low risk market neutral ones.}

\section{Margin trading}

By \textbf{margin trading} we mean a trading style in which a \textbf{dealer} allows a \textbf{trader} to dispose of some of the dealer's money or assets, after the trader has posted a \textbf{margin} $M$ to the dealer's account or to an external, locked one. The quantity of money the dealer allows the trader to trade is called the \textbf{balance} $B$ of the trader. The balance might be in a currency which is different from the margin's one.

This is similar to a collateralised loan, except for the fact that the balance does not actually goes into the trader's hand. It is more convenient to say that the trader has bought the "right" to move the balance from the dealer's account to and from the \textbf{dex} (which we will consider fixed).

Once the trader posts some margin to the dealer, the trader has the right to open a \textbf{position}. Typically, the balance is computed after the position order is received. A position is determined by the following data (by simplicity, we always assume that one token of the traded pair coincides with the margin token):
\begin{itemize}
\item The margin $M$
\item The margin token \verb|TKA|
\item The destination token \verb|TKB|
\item The \textbf{lever} $L > 0$.
\item The \textbf{type} which can be either \textbf{long} or \textbf{short}.
\end{itemize}

We define the \textbf{ratio} $r$ as the exchange value of \verb|TKB|/\verb|TKA| as published by the dex. This can be seen as the number of tokens \verb|TKA| one can obtain by exchanging one unit of \verb|TKB|. Notice that things in reality are much more complicated, since the very action of exchanging tokens in the dex will move this ratio; we will not discuss these subtleties now and simply assume that if we exchange $x$ \verb|TKB| on the dex, we will get $xr$ \verb|TKA|.

\subsection{Long position}

Assume the trader believes that the value of the ratio $r = 10$ is about to \emph{increase} in the future, and that his belief is strong enough that he is willing to post a $100$\verb|TKA| worth of margin and going into a \emph{long position} on \verb|TKB| with a leverage of $10$. At this point, the vault checks if there are $1000$\verb|TKA| available. If it is the case, it will exchange them to buy $100$ \verb|TKB| from the dex. We assume a fee of 1\% on the vault relative to \verb|TKA|, and a risk factor of $50$\% for liquidation.

\subsubsection{Scenario of increasing $r$}
Assume the day after we observe $r = 11$, i.e. an increase of $10$\% with respect to the previous day. At this point, the trader can choose to close his position: the vault will sell back the $100$\verb|TKB| to the dex, but now $1100$\verb|TKA| will be obtained for this amount. The original $1000$\verb|TKA| stay with the vault (recall that do not belong to the trader!) which will refund the trader with the locked margin of $100$\verb|TKA|, plus the extra $100$\verb|TKA| obtained by the exchange, minus $10$\verb|TKA| representing $1$\% of the swapped amount, which represent the fee of the vault. Therefore the trader will go home with $190$\verb|TKA|, that is a gain of $90$\% of the original investment when the market has only shown a $10$\% increase. This happens because of the leverage of $10$ the trader has chosen to undertake. To summarize:
\begin{itemize}
    \item Trader's initial balance: $100$\verb|TKA|, vault's initial balance: $1000$\verb|TKA|.
    \item Trader's final balance: $190$\verb|TKA|, vault's final balance: $1010$\verb|TKA|.
\end{itemize}

\subsubsection{Scenario of decreasing $r$: no liquidation}
Assume the day after we observe $r = 9.8$, i.e. a decrease of $2$\% with respect to the previous day.  At this point, the trader can choose to close his position: the vault will sell back the $100$\verb|TKB| to the dex, but now only $980$\verb|TKA| will be obtained for this amount. The vault will now have to recover from the loss of $20$\verb|TKA|, and it will do by \emph{retaining} $20$\verb|TKA| from the trader's margin, plus $10$\verb|TKA| as fees. The vault will then leave the rest of the margin to the trader, which will go home with $70$\verb|TKA|, realising a loss of $30$\% of the original investment.
\begin{itemize}
    \item Trader's initial balance: $100$\verb|TKA|, vault's initial balance: $1000$\verb|TKA|.
    \item Trader's final balance: $70$\verb|TKA|, vault's final balance: $1010$\verb|TKA|.
\end{itemize}

\subsubsection{Scenario of decreasing $r$: liquidation}
Assume the day after we observe $r = 9.5$, i.e. a decrease of $5$\% with respect to the previous day.  At this point, the vault notices that selling back the $100$\verb|TKB| to the dex, it can only obtain $950$\verb|TKA|. Since the margin is of $100$\verb|TKA|, the fees are $10$\verb|TKA|, and the risk factor has been set to $50$\%, the position will be \emph{liquidated}, i.e. closed by Ithil itself: Ithil will then retain $60$\verb|TKA| to restore entirely the initial amount plus fees, leaving the trader with $40$\verb|TKA|.
\begin{itemize}
    \item Trader's initial balance: $100$\verb|TKA|, vault's initial balance: $1000$\verb|TKA|.
    \item Trader's final balance: $40$\verb|TKA|, vault's final balance: $1010$\verb|TKA|.
\end{itemize}

\subsection{Short position}

Assume the trader believes that the value of the ratio $r = 10$ is about to \emph{decrease} in the future, and that his belief is strong enough that he is willing to post a $100$\verb|TKA| worth of margin and going into a \emph{short position} on \verb|TKB| with a leverage of $10$. At this point, the vault with native token \verb|TKB| checks if it has $1000$\verb|TKA| worth of \verb|TKB| in its pool as of today's market condition: i.e. the vault checks if it has $100$\verb|TKB|. If it does, it exchanges them to obtain $1000$\verb|TKA| from the dex. We assume a fee of 1\% on the vault relative to \verb|TKA|, and a risk factor of $50$\% for liquidation.

\subsubsection{Scenario of decreasing $r$}
Assume the day after we observe $r = 9$, i.e. a decrease of $10$\% with respect to the previous day. At this point, the trader can choose to close his position: the vault will sell back a quantity of \verb|TKA| necessary to obtain back the original $100$\verb|TKB|, plus $1$\verb|TKB| representing the fee. As of today, only $909$\verb|TKA| are necessary. The extra $91$\verb|TKA| will go to the trader together with the margin of $100$\verb|TKA|. Therefore the trader will go home with $191$\verb|TKA|, that is a gain of $91$\% of the original investment when the market has only shown a $10$\% decrease. 
\begin{itemize}
    \item Trader's initial balance: $100$\verb|TKA|, vault's initial balance: $100$\verb|TKB|.
    \item Trader's final balance: $191$\verb|TKA|, vault's final balance: $101$\verb|TKB|.
\end{itemize}
(Notice that the trader has $1$\verb|TKA| more than the analogous scenario we discussed for a long position: this is linked with the fact that the margin posted is in a token, which is different from the one native to the vault. Since the fees are always in the vault's native token, the trader will profit or lose also on the fees for the exchange ratio movements).

\subsubsection{Scenario of increasing $r$: no liquidation}
Assume the day after we observe $r = 10.2$, i.e. an increase of $2$\% with respect to the previous day.  At this point, the trader can choose to close his position: the vault will sell back a quantity of \verb|TKA| necessary to obtain back $101$\verb|TKB| to restore the liquidity and get the fees, but now $1030.2$\verb|TKA| are necessary. The vault only has $1000$\verb|TKA|, thus it will \emph{pick} $30.2$\verb|TKA| from the trader's margin to obtain the desired amount of \verb|TKB|. The vault will then leave the rest of the margin to the trader, which will go home with $69.8$\verb|TKA|.
\begin{itemize}
    \item Trader's initial balance: $100$\verb|TKA|, vault's initial balance: $100$\verb|TKB|.
    \item Trader's final balance: $69.8$\verb|TKA|, vault's final balance: $101$\verb|TKB|.
\end{itemize}

\subsubsection{Scenario of increasing $r$: liquidation}
Assume the day after we observe $r = 10.5$, i.e. an increase of $5$\% with respect to the previous day.  At this point, the vault notices that $1060.5$\verb|TKA| are now necessary to obtain $101$\verb|TKB| to have back the liquidity plus fees. Since the margin is of $100$\verb|TKA|, and the risk factor is set to $50$\%, the position will be \emph{liquidated}. The vault will then withdraw $60.5$\verb|TKA| from the margin and will obtain $101$\verb|TKB| from the dex. The remaining $39.5$\verb|TKA| will go back to the trader.
\begin{itemize}
    \item Trader's initial balance: $100$\verb|TKA|, vault's initial balance: $100$\verb|TKB|.
    \item Trader's final balance: $39.5$\verb|TKA|, vault's final balance: $101$\verb|TKB|.
\end{itemize}

\subsection{Other possibilities}

Similar systems allow long trading with non-native token margin, and short trading with native token margin. In any case, the vault's gain will be of $1$\%, while the trader will be more exposed to the exchange ratio if the margin posted is of a non-native type.

\section{Cross-chain support}
Ithil will support provisioning liquidity from multiple evm-compatible chains as well as running strategies on other chains too.
For instance, LPs can provide liquidity from Ethereum mainnet, Polygon, Avalanche, Harmony, BSC and strategies can be run on all those L2 and sidechains thanks to Composable finance \textit{Persona}s.

\section{Governance}
In a first initial phase governance will be shared among the core team using a multiple key and a multisig contract. The admins will be able to harvest fees, vary the fee ratio and correct the risk factor but cannot alter in any way the current open positions nor interfere with the liquidity pools.
Since contracts are immutable and their implementation cannot be changed, a governance token may be needed to push new functionalities and vote on key parts of the protocol itself, like the choice of the dex. The release of a governance token is left to a second phase in the protocol life when a critical mass of traders, LPs and community DAO members is reached.

Ithil promotes a florid developer community, encouraging the creation of trading bots as well as the interaction with third party smart contracts to manage investments within the limits of the code itself.

In a further step, the aforementioned administrative powers of this contract will be further limited by putting the protocol into a “owner-less” mode, where the core team relinquish control over admin functions to a voting system, thus making Ithil a DAO. A lack of centralized power is essential to the trustlessness of the protocol.

\section{Acknowledgments}

We would like to thank the incredible Ethereum community for its support and welcoming atmosphere as well as ETHGlobal for running hackathons and on boarding new developers while creating connections with key projects in the DeFi space like Uniswap or Yearn finance.

\end{document}
